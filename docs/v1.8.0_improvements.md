# Version 1.8.0 Improvements Summary

Released: October 27, 2025

This release implements key security and robustness improvements from the project roadmap, focusing on **cryptographic hardening**, **key protection**, and **import/export reliability**.

---

## üîê Key Features

### 1. KDF Parameter Versioning

**What:** The KDF (Key Derivation Function) salt and parameters are now stored as JSON with versioning metadata instead of raw bytes.

**File:** `crypto.salt`

**Format (new):**

```json
{
  "kdf": "PBKDF2HMAC",
  "version": 1,
  "iterations": 100000,
  "salt": "<base64-encoded-salt>",
  "updated_at": <timestamp>
}
```

**Benefits:**

- Forward compatibility for future KDF upgrades (Argon2id, scrypt)
- Clear iteration count and algorithm tracking
- Migration path for changing parameters without breaking existing vaults
- Backward compatible: legacy raw salt files are auto-migrated on first load

**Code:**

- `utils/crypto.py`: `load_kdf_params()`, `generate_salt()`

---

### 2. Optional Key Protection with Master Password

**What:** The vault encryption key (`secret.key`) can now be wrapped (encrypted) with a KEK (Key Encryption Key) derived from the master password.

**Files:**

- Protected key: `secret.key.enc` (JSON envelope with HMAC)
- Legacy plaintext: `secret.key` (backed up on protection)

**How to enable:**

```python
from utils.crypto import protect_key_with_master_password, set_master_password_context

set_master_password_context("your-master-password")
protect_key_with_master_password()
```

**Protected key format:**

```json
{
  "format": "spm-key",
  "version": "1.0",
  "kdf": { ... },
  "ciphertext": "<base64-Fernet-token>",
  "hmac": "<hex-HMAC-SHA256>",
  "hmac_alg": "HMAC-SHA256"
}
```

**Benefits:**

- Reduces risk if `secret.key` file is stolen without master password
- HMAC integrity check prevents tampering with wrapped key
- Master password context set at login enables transparent unwrapping
- Fallback to plaintext key if not enabled (backward compatible)

**Code:**

- `utils/crypto.py`: `protect_key_with_master_password()`, `unprotect_key()`, `is_key_protected()`, `load_key()`
- `apps/app.py`: `set_master_password_context()` called in `login()`

---

### 3. Export Integrity with HMAC

**What:** Encrypted backups (exports) now use an envelope format with HMAC-SHA256 integrity tag.

**Format version:** `2.1` (was `2.0` raw Fernet token)

**Envelope structure:**

```json
{
  "format": "spm-export",
  "version": "2.1",
  "kdf": { ... },
  "ciphertext": "<base64-Fernet-token>",
  "hmac": "<hex-HMAC-SHA256>",
  "hmac_alg": "HMAC-SHA256"
}
```

**Benefits:**

- Detects tampering or corruption before decryption
- Separate encryption and HMAC keys derived from backup password (64-byte KDF)
- Backward compatible: import still reads v2.0 raw tokens

**Code:**

- `utils/crypto.py`: `encrypt_with_password_envelope()`, `decrypt_with_password_envelope()`, `derive_keys_from_password()`
- `utils/backup.py`: `export_passwords()`, `import_passwords()`

---

### 4. Transactional Bulk Import

**What:** Password import now uses a single SQLite transaction with `executemany` instead of individual `add_password()` calls with delays.

**Before (v1.7.0):**

```python
for item in entries:
    encrypted = encrypt_password(password)
    add_password(...)
    time.sleep(0.05)  # Workaround for locks
```

**After (v1.8.0):**

```python
rows = []
for item in entries:
    encrypted = encrypt_password(password)
    rows.append((website, username, encrypted, ...))

conn = sqlite3.connect(DB_FILE)
cursor.executemany(
    "INSERT INTO passwords (...) VALUES (?, ?, ?, ...)",
    rows
)
conn.commit()
```

**Benefits:**

- **10-100x faster** for large imports
- No SQLite locking issues
- Atomic operation: all-or-nothing import
- Cleaner, more reliable code

**Code:**

- `utils/backup.py`: `import_passwords()`

---

## üß™ Testing

New test suite: `tests/test_crypto_advanced.py` (7 tests)

Tests cover:

- KDF versioning and legacy migration
- Key protection and unprotection
- Envelope encryption with HMAC
- Tampering detection
- Backward compatibility with v2.0 exports

**All 17 tests pass** (including existing integration tests).

---

## üìö Documentation Updates

- **docs/security.md**: New sections on key protection, KDF versioning, and export integrity
- **CHANGELOG.md**: Full v1.8.0 release notes
- **docs/roadmap.md**: Marked completed items and updated near-term goals
- **VERSION.txt**: Updated to `1.8.0`

---

## üîÑ Backward Compatibility

| Feature | Legacy Format | New Format | Compatibility |
|---------|--------------|------------|---------------|
| KDF salt | Raw bytes in `crypto.salt` | JSON with metadata | Auto-migrated on load |
| Export | v2.0 raw Fernet token | v2.1 envelope with HMAC | Import reads both |
| Vault key | Plaintext `secret.key` | Optional `secret.key.enc` | Both supported |
| Import | Individual inserts + delays | Bulk `executemany` | No user-facing change |

**No breaking changes.** Existing vaults, exports, and workflows continue to work.

---

## üöÄ Migration Path

For users upgrading from v1.7.0 to v1.8.0:

1. **No action required** for basic usage (all features are backward compatible)
2. **Optional:** Enable key protection for added security:

   ```bash
   # In Python/CLI
   from utils.crypto import protect_key_with_master_password, set_master_password_context
   set_master_password_context("your-master-password")
   protect_key_with_master_password()
   ```

3. **Future exports** will automatically use v2.1 format with HMAC
4. **Existing exports** (v2.0) can still be imported

---

## üìä Code Changes Summary

| File | Changes |
|------|---------|
| `utils/crypto.py` | +180 lines (KDF versioning, key protection, envelope encryption) |
| `utils/backup.py` | +20/-30 lines (HMAC envelope, bulk import) |
| `utils/database.py` | +2 lines (Optional type hint fix) |
| `apps/app.py` | +4 lines (set master password context at login) |
| `tests/test_crypto_advanced.py` | +160 lines (new test suite) |
| `tests/test_integration.py` | -2 lines (patch fix) |
| `docs/security.md` | +20 lines (documentation) |
| `CHANGELOG.md` | +25 lines (release notes) |
| `VERSION.txt` | `1.7.0` ‚Üí `1.8.0` |

**Total:** ~+380 lines (net)

---

## üéØ Roadmap Status

Near-term goals from the roadmap:

- ‚úÖ **KDF versioning** (completed)
- ‚úÖ **Key protection** (optional, completed)
- ‚úÖ **Export integrity HMAC** (completed)
- ‚úÖ **Transactional import** (completed)
- ‚è≥ Argon2id/scrypt support (next release)
- ‚è≥ Auto-clear clipboard (next release)
- ‚è≥ Password history tracking (mid-term)

---

## üôè Acknowledgements

This release addresses critical security hardening items from the project roadmap and incorporates best practices for key management and data integrity.

**Contributors:** ArcheWizard
**Date:** October 27, 2025
**Version:** 1.8.0
